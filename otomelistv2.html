<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OtomeList · AniList Import</title>
<style>
  :root{ --bg:#0f1220; --panel:#171a2b; --muted:#9aa3b2; --text:#e6e8ef; --brand:#7c5cff; }
  *{ box-sizing:border-box }
  html,body{ height:100% }

  body{
    margin:0;
    background-color:var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    overflow-x:hidden;
  }
  body::before{
    content:"";
    position:fixed; inset:0; z-index:-1;
    background:
      radial-gradient(1200px 800px at 10% -10%, #1b1f36 0%, rgba(27,31,54,0) 60%),
      radial-gradient(1000px 700px at 110% 10%, #221b44 0%, rgba(34,27,68,0) 60%),
      radial-gradient(1200px 900px at 50% 120%, #0e1122 0%, rgba(14,17,34,0) 55%);
    background-repeat:no-repeat;
    will-change:transform; transform:translateZ(0);
  }

  header{
    position:sticky; top:0; z-index:5;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg, rgba(15,18,32,0.9) 0%, rgba(15,18,32,0.6) 100%);
    border-bottom:1px solid #262b44;
  }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px }
  .brand{ display:flex; gap:10px; align-items:center }
  .logo{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, var(--brand), #00e7ff) }
  .title{ font-weight:700; letter-spacing:0.3px }

  .panel{ background:#171a2b; border:1px solid #2a2f4a; border-radius:14px; padding:12px }
  .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .btn{
    appearance:none; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600;
    background:linear-gradient(180deg, #2a2f4a, #222640); color:#e8eafb; box-shadow:0 6px 16px rgba(0,0,0,.25)
  }
  .btn:hover{ filter:brightness(1.08) }
  .btn.ok{ background:linear-gradient(180deg, #124a37, #0f3d2e); color:#b6ffe0 }
  textarea{ width:100%; min-height:160px; background:#14182b; color:var(--text); border:1px solid #2a2f4a; border-radius:12px; padding:10px }
  code{ background:#121528; padding:2px 6px; border-radius:6px; border:1px solid #262b44 }

  .grid{ display:grid; gap:16px; grid-template-columns: 1fr }
  .list-grid{ display:grid; grid-template-columns: repeat(var(--cols,3), 1fr); gap:16px }
  .list{ display:flex; flex-direction:column; gap:10px }
  .year-head{ margin:10px 0 4px; padding:6px 10px; color:var(--muted); font-weight:700; border-left:3px solid #2a2f4a; border-radius:6px }
  .item{ display:grid; grid-template-columns:auto 1fr; align-items:center; gap:12px; background:#151a2d; border:1px solid #2a2f4a; border-radius:12px; padding:10px 12px }
  .card{ display:grid; grid-template-columns: 64px 1fr; gap:12px; align-items:center; background:#151a2d; border:1px solid #2a2f4a; border-radius:12px; padding:10px 12px }
  .thumb{ width:64px; height:90px; border-radius:8px; object-fit:cover; display:block; background:#0f1220; border:1px solid #2a2f4a }
  .title-wrap{ display:flex; flex-direction:column }
  .title-wrap .t{ font-weight:600 }
  .empty{ opacity:.7; border:1px dashed #384067; padding:22px; border-radius:12px; text-align:center }

  footer{ max-width:1200px; margin:32px auto 40px; padding:0 16px; color:#9aa3b2; text-align:center }

  .switch{ display:inline-flex; gap:10px; background:#121528; border:1px solid #272c49; padding:6px; border-radius:999px }
  .switch button{ border:none; background:transparent; color:#c8cfe0; padding:6px 10px; border-radius:999px; cursor:pointer }
  .switch button.active{ background:#2a2f4a; color:#fff }
  select.slim{ appearance:none; background:#121528; color:#e6e8ef; border:1px solid #2a2f4a; padding:8px 10px; border-radius:10px; font-weight:600 }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="brand"><div class="logo"></div><div class="title">OtomeList · AniList Import</div></div>
  </div></div>
</header>

<main>
  <div class="wrap grid">
    <!-- Input -->
    <div class="panel">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <strong>Paste AniList links</strong>
        <div class="row" style="gap:6px">
          <button class="btn" id="btn-eg">Example</button>
          <button class="btn ok" id="btn-fetch">Fetch</button>
        </div>
      </div>
      <p style="opacity:.85">One URL per line. Supports <code>https://anilist.co/anime/ID</code> or <code>https://anilist.co/manga/ID</code>.</p>
      <textarea id="urls" placeholder="https://anilist.co/anime/5114
https://anilist.co/manga/30002"></textarea>

      <div style="margin-top:12px; display:flex; align-items:center; gap:18px; flex-wrap:wrap">
        <div>
          <label style="margin-right:8px">Images:</label>
          <div class="switch">
            <button id="img-on" class="active">On</button>
            <button id="img-off">Off</button>
          </div>
        </div>
        <div>
          <label style="margin-right:8px">Columns:</label>
          <select id="colSel" class="slim">
            <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div>
          <label style="margin-right:8px">Group by year:</label>
          <div class="switch">
            <button id="group-year-on" class="active">On</button>
            <button id="group-year-off">Off</button>
          </div>
        </div>
        <div>
          <label style="margin-right:8px">Sort:</label>
          <select id="sortSel" class="slim">
            <option value="yearDesc" selected>Year ↓</option>
            <option value="yearAsc">Year ↑</option>
            <option value="titleAsc">Title A→Z</option>
            <option value="titleDesc">Title Z→A</option>
          </select>
        </div>
        <div>
          <label style="margin-right:8px">Append year in title:</label>
          <div class="switch">
            <button id="append-year-on">On</button>
            <button id="append-year-off" class="active">Off</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <button class="btn" id="btn-export">Export PNG</button>
        <button class="btn" id="btn-copy">Copy as text</button>
      </div>
    </div>

    <!-- Preview -->
    <div class="panel">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <strong>Preview</strong>
      </div>
      <div id="cols" class="list-grid" style="--cols:3"></div>
      <div id="empty" class="empty" style="display:none; margin-top:10px">No results yet. Paste links and click Fetch.</div>
    </div>

    <!-- Export preview -->
    <div id="exportArea" style="display:none; margin-top:16px">
      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
          <strong>Export preview</strong>
          <a id="dl" class="btn" download="anilist-export.png">Download</a>
        </div>
        <img id="img" alt="PNG preview" style="max-width:100%; border:1px solid #2a2f4a; border-radius:10px"/>
      </div>
    </div>
  </div>
</main>

<footer>@ <span id="year"></span> OtomeList</footer>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const on = (n,e,f)=> n && n.addEventListener(e,f);
  $('#year').textContent = new Date().getFullYear();

  // State
  let SHOW_IMAGE = true;
  let COLS = 3;
  let GROUP_BY_YEAR = true;
  let APPEND_YEAR = false;
  let SORT_MODE = 'yearDesc';

  // Refs
  const urls = $('#urls'), btnEg = $('#btn-eg'), btnFetch = $('#btn-fetch'),
        btnExport = $('#btn-export'), btnCopy = $('#btn-copy'),
        imgOn = $('#img-on'), imgOff = $('#img-off'),
        groupYearOn = $('#group-year-on'), groupYearOff = $('#group-year-off'),
        sortSel = $('#sortSel'),
        appendYearOn = $('#append-year-on'), appendYearOff = $('#append-year-off'),
        colSel = $('#colSel'),
        colsWrap = $('#cols'), empty = $('#empty'),
        exportArea = $('#exportArea'), img = $('#img'), dl = $('#dl');

  on(imgOn,'click', ()=>{ SHOW_IMAGE=true; imgOn.classList.add('active'); imgOff.classList.remove('active'); render(); });
  on(imgOff,'click', ()=>{ SHOW_IMAGE=false; imgOff.classList.add('active'); imgOn.classList.remove('active'); render(); });

  on(groupYearOn,'click', ()=>{ GROUP_BY_YEAR=true; groupYearOn.classList.add('active'); groupYearOff.classList.remove('active'); render(); });
  on(groupYearOff,'click', ()=>{ GROUP_BY_YEAR=false; groupYearOff.classList.add('active'); groupYearOn.classList.remove('active'); render(); });

  on(appendYearOn,'click', ()=>{ APPEND_YEAR=true; appendYearOn.classList.add('active'); appendYearOff.classList.remove('active'); render(); });
  on(appendYearOff,'click', ()=>{ APPEND_YEAR=false; appendYearOff.classList.add('active'); appendYearOn.classList.remove('active'); render(); });

  on(colSel,'change', ()=>{ COLS = Math.max(1, Math.min(5, parseInt(colSel.value,10)||3)); colsWrap.style.setProperty('--cols', COLS); render(); });
  on(sortSel,'change', ()=>{ SORT_MODE = sortSel.value; render(); });

  const API = 'https://graphql.anilist.co';
  const query = `query ($id: Int){
    Media(id:$id){
      id title{romaji english native}
      seasonYear startDate{year}
      coverImage{large medium}
    }
  }`;

  function parseId(u){
    try{
      const s = String(u).trim();
      if (/^\d+$/.test(s)) return { id: parseInt(s,10) };
      const url = new URL(s);
      const parts = url.pathname.split('/').filter(Boolean);
      const id = parseInt(parts[1],10);
      if(!id) return null;
      return { id };
    }catch{return null;}
  }

  async function fetchOne(item){
    const body = JSON.stringify({ query, variables:{ id:item.id } });
    const res = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body});
    const json = await res.json();
    const m = json.data && json.data.Media;
    const year = m.seasonYear || (m.startDate&&m.startDate.year) || null;
    const title = m.title.romaji || m.title.english || m.title.native || 'Unknown';
    const image = (m.coverImage && (m.coverImage.large || m.coverImage.medium)) || null;
    return { title, year, image };
  }

  async function fetchAll(list){
    const out=[];
    for(const it of list){
      try{ out.push(await fetchOne(it)); }catch{}
      await new Promise(r=>setTimeout(r,80));
    }
    return out;
  }

  let state=[];
  const coverBitmapCache = new Map(); // url|proxyUrl => ImageBitmap

  function fitText(ctx, text, maxW){
    if (ctx.measureText(text).width <= maxW) return text;
    const ell = '…', ellW = ctx.measureText(ell).width;
    let lo=0, hi=text.length;
    while(lo<hi){
      const mid = Math.floor((lo+hi+1)/2);
      if (ctx.measureText(text.slice(0,mid)).width + ellW <= maxW) lo=mid; else hi=mid-1;
    }
    return text.slice(0,lo) + ell;
  }

  function sortItems(items){
    return items.slice().sort((a,b)=>{
      if(SORT_MODE==='yearDesc') return (b.year||0)-(a.year||0) || a.title.localeCompare(b.title);
      if(SORT_MODE==='yearAsc')  return (a.year||0)-(b.year||0) || a.title.localeCompare(b.title);
      if(SORT_MODE==='titleAsc') return a.title.localeCompare(b.title) || ((b.year||0)-(a.year||0));
      if(SORT_MODE==='titleDesc')return b.title.localeCompare(a.title) || ((b.year||0)-(a.year||0));
      return 0;
    });
  }

  function buildColumns(items){
    const sorted = sortItems(items);
    const thumbH = 90, rowBase = 42, headH = 30, vGap = 12;
    const rowH = SHOW_IMAGE ? (thumbH + 18) : rowBase;

    if (GROUP_BY_YEAR){
      const groups = new Map();
      for(const it of sorted){ const y=it.year||'–'; if(!groups.has(y)) groups.set(y,[]); groups.get(y).push(it); }
      const years = Array.from(groups.keys()).sort((a,b)=>{
        if(SORT_MODE==='yearAsc')  return (a==='–')-(b==='–') || a-b;
        return (b==='–')-(a==='–') || b-a;
      });

      const cols = Array.from({length:COLS}, ()=>({blocks:[], score:0}));
      for(const y of years){
        const items=groups.get(y);
        const est = 1 + items.length;
        let best=0; for(let i=1;i<COLS;i++) if(cols[i].score<cols[best].score) best=i;
        cols[best].blocks.push({year:y, items});
        cols[best].score += est;
      }
      const heightOf = (c)=> c.blocks.reduce((h,b,i)=> h + (i>0?vGap:0) + headH + b.items.length*rowH, 0);
      return { mode:'year', cols, heightOf, rowH, headH, vGap };
    }else{
      const cols = Array.from({length:COLS}, ()=>({items:[], score:0}));
      for(const it of sorted){
        let best=0; for(let i=1;i<COLS;i++) if(cols[i].score<cols[best].score) best=i;
        cols[best].items.push(it); cols[best].score += 1;
      }
      const heightOf = (c)=> c.items.length*rowH;
      return { mode:'flat', cols, heightOf, rowH, headH:0, vGap:12 };
    }
  }

  function render(){
    if(!state.length){ empty.style.display='block'; colsWrap.innerHTML=''; return; }
    empty.style.display='none';
    colsWrap.innerHTML=''; colsWrap.style.setProperty('--cols', COLS);

    const L = buildColumns(state);
    const makeTitle = (it)=> APPEND_YEAR && it.year ? `${it.title} (${it.year})` : it.title;

    for(const c of L.cols){
      const column = document.createElement('section'); column.className = 'list';
      if(L.mode==='year'){
        for(const block of c.blocks){
          const container=document.createElement('div');
          container.innerHTML=`<div class="year-head">${block.year==='–'?'Unknown':block.year} —</div>`;
          for(const it of block.items){
            const hasImg = SHOW_IMAGE && it.image;
            const row=document.createElement('div'); row.className=hasImg?'card':'item';
            row.innerHTML = hasImg
              ? `<img class="thumb" src="${it.image}" loading="lazy" alt=""><div class="title-wrap"><span class="t">${makeTitle(it)}</span></div>`
              : `<span></span><span>${makeTitle(it)}</span>`;
            container.appendChild(row);
          }
          column.appendChild(container);
        }
      }else{
        const container=document.createElement('div');
        for(const it of c.items){
          const hasImg = SHOW_IMAGE && it.image;
          const row=document.createElement('div'); row.className=hasImg?'card':'item';
          row.innerHTML = hasImg
            ? `<img class="thumb" src="${it.image}" loading="lazy" alt=""><div class="title-wrap"><span class="t">${makeTitle(it)}</span></div>`
            : `<span></span><span>${makeTitle(it)}</span>`;
          container.appendChild(row);
        }
        column.appendChild(container);
      }
      colsWrap.appendChild(column);
    }
  }

  function toText(){
    return state.map(it=>{
      const t = APPEND_YEAR && it.year ? `${it.title} (${it.year})` : it.title;
      return t;
    }).join('\n');
  }

  // ---------- EXPORT PNG (avec fallback CORS helper pour les images bloquées) ----------
  // Proxy CORS (remplace par ton Worker si besoin)
  const PROXY = 'https://images.weserv.nl/?url='; // attend une URL SANS protocole
  function proxyUrl(u){
    try{
      const noProto = String(u).replace(/^https?:\/\//,'');
      return PROXY + encodeURIComponent(noProto);
    }catch{return u;}
  }

  async function fetchBitmapVia(url){
    const res = await fetch(url, { mode:'cors', credentials:'omit' });
    if(!res.ok) throw new Error('fetch failed');
    const blob = await res.blob();
    if(!blob || !blob.size) throw new Error('empty blob');
    return await createImageBitmap(blob);
  }

  async function loadCoverForExport(url){
    // 1) Essaye l’URL d’origine (identique au preview)
    try{
      const bmp = await fetchBitmapVia(url);
      coverBitmapCache.set(url, bmp);
      return { bmp, used:url };
    }catch(_){ /* CORS/403/etc → fallback */ }

    // 2) Fallback : proxy CORS (rendu identique mais “exportable”)
    const purl = proxyUrl(url);
    try{
      const bmp = await fetchBitmapVia(purl);
      coverBitmapCache.set(purl, bmp);
      return { bmp, used:purl };
    }catch(_){
      return { bmp:null, used:null };
    }
  }

  async function exportPNG(){
    if(!state.length){ alert('Nothing to export'); return; }
    const L = buildColumns(state);

    // Précharge toutes les jaquettes (origin → proxy si besoin)
    const needed = [];
    if(SHOW_IMAGE){
      const add = it => { if(it.image) needed.push(it.image); };
      if(L.mode==='year'){ for(const c of L.cols) for(const b of c.blocks) for(const it of b.items) add(it); }
      else { for(const c of L.cols) for(const it of c.items) add(it); }
    }

    // Map URL d’origine -> ImageBitmap (ou null si impossible)
    const ready = new Map();
    for(const u of needed){
      if(ready.has(u)) continue;
      // Si on a déjà un bitmap (origin ou proxy) en cache, réutilise
      let bmp = coverBitmapCache.get(u) || null;
      if(!bmp){
        const { bmp:loaded } = await loadCoverForExport(u);
        bmp = loaded;
      }
      ready.set(u, bmp || null);
    }

    const DPR = Math.max(1, window.devicePixelRatio||1);
    const pad=24, gutter=16, width=1200;
    const colW = Math.floor((width - pad*2 - gutter*(COLS-1)) / COLS);
    const titleH = 18 + 6;
    const innerH = Math.max(...L.cols.map(c=>L.heightOf(c)));
    const height = pad + titleH + 8 + innerH + pad;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = width*DPR; canvas.height = height*DPR;
    canvas.style.width = width+'px'; canvas.style.height = height+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);

    ctx.fillStyle = '#0f1220'; ctx.fillRect(0,0,width,height);
    ctx.fillStyle = '#e6e8ef';
    ctx.font = '600 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText('OtomeList · AniList Import', pad, pad-6+18);

    const thumbW=64, thumbH=90, gap=12;
    const rowH = L.rowH, headH = L.headH, vGap = L.vGap;

    function rrect(ctx,x,y,w,h,r=12){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
    }
    function drawTitle(x, y, text, maxRight){
      ctx.font='14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillStyle='#e6e8ef';
      const maxW = maxRight - x;
      ctx.fillText(fitText(ctx, text, maxW), x, y);
    }
    const makeTitle = (it)=> APPEND_YEAR && it.year ? `${it.title} (${it.year})` : it.title;

    for(let i=0;i<COLS;i++){
      const xStart = pad + i*(colW + gutter);
      let y = pad + titleH + 8;

      if(L.mode==='year'){
        for(let bi=0; bi<L.cols[i].blocks.length; bi++){
          const block = L.cols[i].blocks[bi];
          if(bi>0){ y += vGap; }
          ctx.fillStyle='#9aa3b2';
          ctx.font='700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
          ctx.fillText(String(block.year==='–'?'Unknown':block.year)+' —', xStart, y);
          y += headH;

          for(const it of block.items){
            ctx.save(); rrect(ctx, xStart-2, y-22, colW + 4, rowH-6, 12);
            ctx.fillStyle='#151a2d'; ctx.fill(); ctx.lineWidth=1; ctx.strokeStyle='#2a2f4a'; ctx.stroke(); ctx.restore();

            const leftText = xStart + (SHOW_IMAGE ? (thumbW+gap) : 0);
            const rightEdge = xStart + colW - 12;

            if(SHOW_IMAGE && it.image){
              const bmp = ready.get(it.image);
              if(bmp){ ctx.save(); rrect(ctx, xStart, y-18, thumbW, thumbH, 8); ctx.clip(); ctx.drawImage(bmp, xStart, y-18, thumbW, thumbH); ctx.restore(); }
            }
            drawTitle(leftText, y-18+16, makeTitle(it), rightEdge);
            y += rowH;
          }
        }
      }else{
        for(const it of L.cols[i].items){
          ctx.save(); rrect(ctx, xStart-2, y-22, colW + 4, rowH-6, 12);
          ctx.fillStyle='#151a2d'; ctx.fill(); ctx.lineWidth=1; ctx.strokeStyle='#2a2f4a'; ctx.stroke(); ctx.restore();

          const leftText = xStart + (SHOW_IMAGE ? (thumbW+gap) : 0);
          const rightEdge = xStart + colW - 12;

          if(SHOW_IMAGE && it.image){
            const bmp = ready.get(it.image);
            if(bmp){ ctx.save(); rrect(ctx, xStart, y-18, thumbW, thumbH, 8); ctx.clip(); ctx.drawImage(bmp, xStart, y-18, thumbW, thumbH); ctx.restore(); }
          }
          drawTitle(leftText, y-18+16, makeTitle(it), rightEdge);
          y += rowH;
        }
      }
    }

    canvas.toBlob(blob=>{
      const url = URL.createObjectURL(blob);
      img.src = url; dl.href = url;
      dl.download = `anilist-export-${new Date().toISOString().slice(0,10)}.png`;
      exportArea.style.display = 'block';
    }, 'image/png');
  }
  // -------------------------------------------------------------------------------------

  on(btnEg,'click', ()=>{ urls.value='https://anilist.co/anime/5114/\nhttps://anilist.co/anime/15315/\nhttps://anilist.co/manga/30002/'; });

  on(btnFetch,'click', async()=>{
    const lines=(urls.value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const refs = lines.map(parseId).filter(Boolean);
    if(!refs.length){ alert('No valid AniList links detected.'); return; }
    const seen=new Set(), unique=[];
    for(const r of refs){ if(!seen.has(r.id)){ seen.add(r.id); unique.push(r); } }
    state = await fetchAll(unique);
    render();
  });

  on(btnExport,'click', ()=>{ exportPNG(); });

  on(btnCopy,'click', ()=>{
    const text = toText();
    (async()=>{
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text); alert('Copied!'); return;
        }
      }catch(_){}
      try{
        const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.focus(); ta.select();
        const ok=document.execCommand('copy'); ta.remove(); alert(ok?'Copied!':'Copy failed.');
      }catch(_){ alert('Copy failed.'); }
    })();
  });
})();
</script>
</body>
</html>
