<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OtomeList · AniList Import</title>
  <style>
    :root{ --bg:#0f1220; --panel:#171a2b; --muted:#9aa3b2; --text:#e6e8ef; --brand:#7c5cff; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1b1f36 0%, rgba(27,31,54,0) 60%),
        radial-gradient(1000px 700px at 110% 10%, #221b44 0%, rgba(34,27,68,0) 60%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg, rgba(15,18,32,0.9) 0%, rgba(15,18,32,0.6) 100%);
      border-bottom:1px solid #262b44;
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px }
    .brand{ display:flex; gap:10px; align-items:center }
    .logo{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, var(--brand), #00e7ff) }
    .title{ font-weight:700; letter-spacing:0.3px }

    .panel{ background:#171a2b; border:1px solid #2a2f4a; border-radius:14px; padding:12px }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .btn{
      appearance:none; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600;
      background:linear-gradient(180deg, #2a2f4a, #222640); color:#e8eafb; box-shadow:0 6px 16px rgba(0,0,0,.25)
    }
    .btn:hover{ filter:brightness(1.08) }
    .btn.ok{ background:linear-gradient(180deg, #124a37, #0f3d2e); color:#b6ffe0 }
    textarea{ width:100%; min-height:160px; background:#14182b; color:var(--text); border:1px solid #2a2f4a; border-radius:12px; padding:10px }
    code{ background:#121528; padding:2px 6px; border-radius:6px; border:1px solid #262b44 }

    /* Toujours 1 colonne : preview en dessous */
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr }

    /* Preview – nb colonnes piloté par la var CSS --cols */
    .list-grid{ display:grid; grid-template-columns: repeat(var(--cols,2), 1fr); gap:16px }
    .list{ display:flex; flex-direction:column; gap:10px }
    .year-head{ margin:10px 0 4px; padding:6px 10px; color:var(--muted); font-weight:700; border-left:3px solid #2a2f4a; border-radius:6px }
    .item{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px; background:#151a2d; border:1px solid #2a2f4a; border-radius:12px; padding:10px 12px }
    .card{ display:grid; grid-template-columns: 64px 1fr auto; gap:12px; align-items:center; background:#151a2d; border:1px solid #2a2f4a; border-radius:12px; padding:10px 12px }
    .thumb{ width:64px; height:90px; border-radius:8px; object-fit:cover; display:block; background:#0f1220; border:1px solid #2a2f4a }
    .title-wrap{ display:flex; flex-direction:column }
    .title-wrap .t{ font-weight:600 }
    .tag{ margin-top:4px; width:max-content; border:1px solid #32375a; border-radius:999px; padding:4px 8px; font-size:12px; color:#e6e8ef; background:#2a2f4a }
    .year{ color:var(--muted) }
    .empty{ opacity:.7; border:1px dashed #384067; padding:22px; border-radius:12px; text-align:center }

    footer{ max-width:1200px; margin:32px auto 40px; padding:0 16px; color:var(--muted); text-align:center }
    label.inline{ display:inline-flex; align-items:center; gap:8px }
    .switch{ display:inline-flex; gap:10px; background:#121528; border:1px solid #272c49; padding:6px; border-radius:999px }
    .switch button{ border:none; background:transparent; color:#c8cfe0; padding:6px 10px; border-radius:999px; cursor:pointer }
    .switch button.active{ background:#2a2f4a; color:#fff }

    select.slim{ appearance:none; background:#121528; color:#e6e8ef; border:1px solid #2a2f4a; padding:8px 10px; border-radius:10px; font-weight:600 }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <div class="brand"><div class="logo"></div><div class="title">OtomeList · AniList Import</div></div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap grid">
      <!-- Input -->
      <div class="panel">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
          <strong>Paste AniList links</strong>
          <div class="row" style="gap:6px">
            <button class="btn" id="btn-eg">Example</button>
            <button class="btn ok" id="btn-fetch">Fetch</button>
          </div>
        </div>
        <p style="opacity:.85">One URL per line. Supports <code>https://anilist.co/anime/ID</code> or <code>https://anilist.co/manga/ID</code>.</p>
        <textarea id="urls" placeholder="https://anilist.co/anime/5114
https://anilist.co/manga/30002"></textarea>

        <div style="margin-top:12px; display:flex; align-items:center; gap:18px; flex-wrap:wrap">
          <div>
            <label class="inline" style="margin-right:8px">Tag mode:</label>
            <div class="switch">
              <button id="mode-auto" class="active">Auto (Anime/Manga)</button>
              <button id="mode-none">None (title + year)</button>
            </div>
          </div>
          <div>
            <label class="inline" style="margin-right:8px">Images:</label>
            <div class="switch">
              <button id="img-on" class="active">On</button>
              <button id="img-off">Off</button>
            </div>
          </div>
          <div>
            <label class="inline" style="margin-right:8px">Columns:</label>
            <select id="colSel" class="slim">
              <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <button class="btn" id="btn-export">Export PNG</button>
          <button class="btn" id="btn-copy">Copy as text</button>
        </div>
      </div>

      <!-- Preview -->
      <div class="panel">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
          <strong>Preview</strong>
          <div class="row" style="gap:6px">
            <select id="sortSel" class="slim">
              <option value="yearDesc">Year ↓</option>
              <option value="yearAsc">Year ↑</option>
              <option value="titleAsc">Title A→Z</option>
              <option value="titleDesc">Title Z→A</option>
            </select>
          </div>
        </div>
        <div id="cols" class="list-grid" style="--cols:3"></div>
        <div id="empty" class="empty" style="display:none; margin-top:10px">No results yet. Paste links and click Fetch.</div>
      </div>

      <!-- Export preview -->
      <div id="exportArea" style="display:none; margin-top:16px">
        <div class="panel">
          <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
            <strong>Export preview</strong>
            <a id="dl" class="btn" download="anilist-export.png">Download</a>
          </div>
          <img id="img" alt="PNG preview" style="max-width:100%; border:1px solid #2a2f4a; border-radius:10px"/>
        </div>
      </div>
    </div>
  </main>

  <footer>@ <span id="year"></span> OtomeList</footer>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const on = (n,e,f)=> n && n.addEventListener(e,f);
  $('#year').textContent = new Date().getFullYear();

  let TAG_MODE = 'auto';
  let SHOW_IMAGE = true;
  let COLS = 3;              // 1..5

  // Refs
  const urls = $('#urls'), btnEg = $('#btn-eg'), btnFetch = $('#btn-fetch'),
        btnExport = $('#btn-export'), btnCopy = $('#btn-copy'),
        modeAuto = $('#mode-auto'), modeNone = $('#mode-none'),
        imgOn = $('#img-on'), imgOff = $('#img-off'),
        sortSel = $('#sortSel'), colSel = $('#colSel'),
        colsWrap = $('#cols'),
        empty = $('#empty'), exportArea = $('#exportArea'), img = $('#img'), dl = $('#dl');

  on(modeAuto,'click', ()=>{ TAG_MODE='auto'; modeAuto.classList.add('active'); modeNone.classList.remove('active'); render(); });
  on(modeNone,'click', ()=>{ TAG_MODE='none'; modeNone.classList.add('active'); modeAuto.classList.remove('active'); render(); });
  on(imgOn,'click', ()=>{ SHOW_IMAGE=true; imgOn.classList.add('active'); imgOff.classList.remove('active'); render(); });
  on(imgOff,'click', ()=>{ SHOW_IMAGE=false; imgOff.classList.add('active'); imgOn.classList.remove('active'); render(); });
  on(colSel,'change', ()=>{ COLS = Math.max(1, Math.min(5, parseInt(colSel.value,10)||3)); colsWrap.style.setProperty('--cols', COLS); render(); });

  const API = 'https://graphql.anilist.co';
  const query = `query ($id: Int){
    Media(id:$id){
      id type title{romaji english native}
      seasonYear startDate{year}
      coverImage{large medium color}
    }
  }`;

  function parseId(u){
    try{
      const s = String(u).trim();
      if (/^\d+$/.test(s)) return { id: parseInt(s,10), kind: 'anime' };
      const url = new URL(s);
      const parts = url.pathname.split('/').filter(Boolean);
      const type = (parts[0]||'').toLowerCase();
      const id = parseInt(parts[1],10);
      if(!id) return null;
      if(type!=='anime'&&type!=='manga') return null;
      return { id, kind:type };
    }catch{return null;}
  }

  async function fetchOne(item){
    const body = JSON.stringify({ query, variables:{ id:item.id } });
    const res = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body});
    const json = await res.json();
    const m = json.data && json.data.Media;
    const year = m.seasonYear || (m.startDate&&m.startDate.year) || null;
    const title = m.title.romaji || m.title.english || m.title.native || 'Unknown';
    const type = (TAG_MODE==='auto') ? (m.type==='ANIME'?'Anime':'Manga') : null;
    const image = (m.coverImage && (m.coverImage.large || m.coverImage.medium)) || null;
    return { title, year, type, image };
  }

  async function fetchAll(list){
    const out=[];
    for(const it of list){
      try{ out.push(await fetchOne(it)); }catch{}
      await new Promise(r=>setTimeout(r,80));
    }
    return out;
  }

  let state=[];

  // -------- Layout balancing (N colonnes) ----------
  function buildColumns(groups, years, wantImages, nCols){
    const thumbH = 90, rowBase = 42, headH = 30, vGap = 12;
    const rowH = wantImages ? (thumbH + 18) : rowBase;

    const cols = Array.from({length:nCols}, ()=>({blocks:[], score:0}));
    for(const y of years){
      const items = groups.get(y);
      const est = 1 + items.length;      // même heuristique que le preview d’origine
      // place le bloc dans la colonne la moins “haute”
      let best = 0;
      for(let i=1;i<nCols;i++) if(cols[i].score < cols[best].score) best = i;
      cols[best].blocks.push({year:y, items});
      cols[best].score += est;
    }

    // fonction hauteur réelle (px) d'une colonne
    const heightOf = (c)=> c.blocks.reduce((h,b,i)=> h + (i>0?vGap:0) + headH + b.items.length*rowH, 0);

    return { cols, heightOf, rowH, headH, vGap };
  }

  // --------------- PREVIEW RENDER ------------------
  function render(){
    if(!state.length){
      empty.style.display='block'; colsWrap.innerHTML=''; return;
    }
    empty.style.display='none';
    colsWrap.innerHTML=''; colsWrap.style.setProperty('--cols', COLS);

    const s = sortSel.value || 'yearDesc';
    const items = state.slice().sort((a,b)=>{
      if(s==='yearDesc') return (b.year||0)-(a.year||0) || a.title.localeCompare(b.title);
      if(s==='yearAsc')  return (a.year||0)-(b.year||0) || a.title.localeCompare(b.title);
      if(s==='titleAsc') return a.title.localeCompare(b.title) || ((b.year||0)-(a.year||0));
      if(s==='titleDesc')return b.title.localeCompare(a.title) || ((b.year||0)-(a.year||0));
      return 0;
    });

    const groups = new Map();
    for(const it of items){
      const y=it.year||'–';
      if(!groups.has(y)) groups.set(y,[]);
      groups.get(y).push(it);
    }
    const years = Array.from(groups.keys()).sort((a,b)=> s==='yearAsc' ? ((a==='–')-(b==='–')||a-b) : ((b==='–')-(a==='–')||b-a));

    const { cols } = buildColumns(groups, years, SHOW_IMAGE, COLS);

    // Crée N colonnes et les remplit
    for(const c of cols){
      const column = document.createElement('section');
      column.className = 'list';
      for(const block of c.blocks){
        const container=document.createElement('div');
        container.innerHTML=`<div class="year-head">${block.year==='–'?'Unknown':block.year} —</div>`;
        for(const it of block.items){
          const hasImg = SHOW_IMAGE && it.image;
          const row=document.createElement('div'); row.className=hasImg?'card':'item';
          const tag = (TAG_MODE==='auto' && it.type)?`<span class="tag">${it.type}</span>`:'';
          row.innerHTML = hasImg
            ? `<img class="thumb" src="${it.image}" loading="lazy" alt=""><div class="title-wrap"><span class="t">${it.title}</span>${tag}</div><span class="year">${it.year||'–'}</span>`
            : `${tag}<span>${it.title}</span><span class="year">${it.year||'–'}</span>`;
          container.appendChild(row);
        }
        column.appendChild(container);
      }
      colsWrap.appendChild(column);
    }
  }

  function toText(){
    return state.map(it=>{
      const core = `${it.title} (${it.year||''})`.trim();
      if(TAG_MODE==='auto' && it.type){ return `[${it.type}] ${core}`; }
      return core;
    }).join('\n');
  }

  // --- Export helpers (images + shapes) ---
  function rrect(ctx,x,y,w,h,r=12){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }
  async function loadCover(url){
    try{
      const r = await fetch(url,{mode:'cors',referrerPolicy:'no-referrer'});
      if(r.ok){
        const b = await r.blob();
        if(b && b.size){
          const bmp = await createImageBitmap(b);
          return {kind:'bitmap',img:bmp};
        }
      }
    }catch(_){}
    return new Promise((res,rej)=>{
      const el = new Image();
      el.crossOrigin = 'anonymous';
      try{ el.referrerPolicy = 'no-referrer'; }catch(_){}
      el.onload = ()=>res({kind:'img',img:el});
      el.onerror = ()=>rej(new Error('img load fail'));
      el.src = url;
    });
  }

  // ---------------- EXPORT (N colonnes) -----------------
  async function exportPNG(){
    if(!state.length){ alert('Nothing to export'); return; }

    const s = sortSel.value || 'yearDesc';
    const groups = new Map();
    for(const it of state){ const y = it.year || '–'; if(!groups.has(y)) groups.set(y, []); groups.get(y).push(it); }
    const years = Array.from(groups.keys()).sort((a,b)=> s==='yearAsc' ? ((a==='–')-(b==='–')||a-b) : ((b==='–')-(a==='–')||b-a));

    const WANT_IMG = SHOW_IMAGE === true;

    // Précharge les images seulement si ON
    const coverMap = new Map();
    if(WANT_IMG){
      for(const y of years){
        for(const it of groups.get(y)){
          if(it.image && !coverMap.has(it)){
            try{ coverMap.set(it, await loadCover(it.image)); }catch(_){}
          }
        }
      }
    }

    // Calcul colonnes (même logique que preview)
    const { cols, heightOf, rowH, headH, vGap } = buildColumns(groups, years, WANT_IMG, COLS);

    // Dimensions canvas
    const DPR = Math.max(1, window.devicePixelRatio||1);
    const pad=24, gutter=16;
    const totalWidth = 1200;                                   // largeur cible
    const width = Math.max(900, totalWidth);                   // minimum
    const colW = Math.floor((width - pad*2 - gutter*(COLS-1)) / COLS);
    const titleH = 18 + 6;
    const innerH = Math.max(...cols.map(c=>heightOf(c)));
    const height = pad + titleH + 8 + innerH + pad;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = width*DPR; canvas.height = height*DPR;
    canvas.style.width = width+'px'; canvas.style.height = height+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);

    // Fond + titre
    ctx.fillStyle = '#0f1220'; ctx.fillRect(0,0,width,height);
    ctx.fillStyle = '#e6e8ef';
    ctx.font = '600 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText('OtomeList · AniList Import', pad, pad-6+18);

    // Dessin colonnes
    for(let i=0;i<COLS;i++){
      const xStart = pad + i*(colW + gutter);
      let y = pad + titleH + 8;
      const c = cols[i];
      for(let bi=0; bi<c.blocks.length; bi++){
        const block = c.blocks[bi];
        if(bi>0){ y += vGap; }
        // année
        ctx.fillStyle = '#9aa3b2';
        ctx.font = '700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.fillText(String(block.year==='–'?'Unknown':block.year)+' —', xStart, y);
        y += headH;

        // items
        for(const it of block.items){
          // carte
          ctx.save();
          rrect(ctx, xStart-2, y-22, colW + 4, rowH-6, 12);
          ctx.fillStyle='#151a2d'; ctx.fill();
          ctx.lineWidth=1; ctx.strokeStyle='#2a2f4a'; ctx.stroke();
          ctx.restore();

          const thumbW=64, thumbH=90, gap=12;
          const leftText = xStart + (WANT_IMG ? (thumbW+gap) : 0);

          // vignette
          const cover = WANT_IMG ? coverMap.get(it) : null;
          if(cover){
            ctx.save();
            rrect(ctx, xStart, y-18, thumbW, thumbH, 8);
            ctx.clip();
            ctx.drawImage(cover.img, xStart, y-18, thumbW, thumbH);
            ctx.restore();
          }

          // tag
          const useTag = (TAG_MODE==='auto' && it.type);
          let titleX = leftText;
          if(useTag){
            const tag = it.type;
            ctx.font='12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
            const tagPadX=10, tagH=24, tagW = Math.ceil(ctx.measureText(tag).width)+tagPadX*2;
            ctx.save(); rrect(ctx, titleX, y-18, tagW, tagH, 12); ctx.fillStyle='#2a2f4a'; ctx.fill(); ctx.lineWidth=1; ctx.strokeStyle='#32375a'; ctx.stroke(); ctx.restore();
            ctx.fillStyle='#e6e8ef'; ctx.fillText(tag, titleX+tagPadX, y-18+16);
            titleX += tagW + 12;
          }

          // titre
          ctx.font='14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
          ctx.fillStyle='#e6e8ef';
          ctx.fillText(it.title, titleX, y-18+16);

          // année
          const ys = String(it.year||'');
          const yw = ctx.measureText(ys).width;
          ctx.fillStyle='#9aa3b2';
          ctx.fillText(ys, xStart + colW - 12 - yw, y-18+16);

          y += rowH;
        }
      }
    }

    const url = canvas.toDataURL('image/png');
    img.src = url; dl.href = url;
    dl.download = `anilist-export-${new Date().toISOString().slice(0,10)}.png`;
    exportArea.style.display = 'block';
  }

  // ------ UI ------
  on(btnEg,'click', ()=>{ urls.value='https://anilist.co/anime/5114/\nhttps://anilist.co/anime/15315/\nhttps://anilist.co/manga/30002/'; });

  on(btnFetch,'click', async()=>{
    const lines=(urls.value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const refs = lines.map(parseId).filter(Boolean);
    if(!refs.length){ alert('No valid AniList links detected.'); return; }
    const seen=new Set(), unique=[];
    for(const r of refs){ if(!seen.has(r.id)){ seen.add(r.id); unique.push(r); } }
    state = await fetchAll(unique);
    render();
  });

  on(btnExport,'click', ()=>{ exportPNG(); });

  on(btnCopy,'click', ()=>{
    const text = toText();
    (async()=>{
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text); alert('Copied!'); return;
        }
      }catch(_){}
      try{
        const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.focus(); ta.select();
        const ok=document.execCommand('copy'); ta.remove(); alert(ok?'Copied!':'Copy failed.');
      }catch(_){ alert('Copy failed.'); }
    })();
  });

  on(sortSel,'change', render);
})();
</script>
</body>
</html>
