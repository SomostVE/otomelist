<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Otomelist — Catalogue d’anime</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --muted:#9aa3b2; --text:#e6e8ef; --badge:#2a2f4a;
    }
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    textarea{width:100%;min-height:140px;background:var(--panel);color:var(--text);
      border:1px solid #2a2f4a;border-radius:12px;padding:12px}
    .btn{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;
      background:linear-gradient(180deg,#2a2f4a,#222640);color:#e8eafb;font-weight:600}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:16px}
    .item{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;
      background:var(--panel);border:1px solid #2a2f4a;border-radius:12px;padding:10px 12px}
    .tag{border-radius:999px;padding:4px 8px;font-size:12px;background:var(--badge)}
    .title{font-weight:600}
    .year{color:var(--muted)}
    #exportArea{margin-top:20px;display:none}
    #exportImg{max-width:100%;border:1px solid #2a2f4a;border-radius:10px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Otomelist</h1>
    <p>Collez vos titres ci-dessous puis exportez en image.</p>
    <textarea id="source" placeholder="isekai The Dark History of the Reincarnated Villainess 2025"></textarea>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btn-render">Rafraîchir</button>
      <button class="btn" id="btn-export">Exporter PNG</button>
    </div>
    <div class="list" id="list"></div>
    <div id="exportArea">
      <a id="exportLink" class="btn" download="otomelist.png">Télécharger</a>
      <img id="exportImg" alt="Aperçu PNG de la liste"/>
    </div>
  </div>

<script>
(function(){
  const source = document.getElementById('source');
  const listEl = document.getElementById('list');
  const exportImg = document.getElementById('exportImg');
  const exportLink = document.getElementById('exportLink');
  const exportArea = document.getElementById('exportArea');
  const DPR = Math.max(1, window.devicePixelRatio || 1);

  function clean(s){return (s||'').trim().replace(/\s{2,}/g,' ')}
  function titleCase(s){return s.replace(/(^|\\s|-|_)([a-zà-ÿ])/gi,(m,p1,p2)=>p1+p2.toUpperCase())}

  function parseLine(line){
    if(!line) return null;
    let m;
    m=line.match(/^\\s*\\[(.+?)\\]\\s*(.+?)\\s*\\((\\d{4})\\)\\s*$/i);
    if(m) return {type:titleCase(clean(m[1])),title:clean(m[2]),year:+m[3]};
    m=line.match(/^\\s*([\\p{L}0-9_-]+)\\s+(.+?)\\s+(\\d{4})\\s*$/u);
    if(m) return {type:titleCase(clean(m[1])),title:clean(m[2]),year:+m[3]};
    m=line.match(/^\\s*(.+?)\\s*\\((\\d{4})\\)\\s*$/);
    if(m) return {type:'Autre',title:clean(m[1]),year:+m[2]};
    return null;
  }

  function parseAll(text){
    const items=[];
    (text||'').split(/\\n+/).forEach(l=>{
      const it=parseLine(l.trim());
      if(it) items.push(it);
    });
    return items;
  }

  function colorFor(key){
    let h=0; for(let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))>>>0;
    const hue=h%360;
    return {
      bg:`hsl(${hue} 55% 20% / 0.7)`,
      border:`hsl(${hue} 60% 38% / 0.9)`,
      text:`hsl(${hue} 80% 85% / 0.98)`
    };
  }

  function render(){
    const items=parseAll(source.value);
    listEl.innerHTML='';
    items.forEach(it=>{
      const div=document.createElement('div');
      div.className='item';
      const c=colorFor(it.type);
      div.innerHTML=`<span class="tag" style="background:${c.bg};border:1px solid ${c.border};color:${c.text}">${it.type}</span>
                     <span class="title">${it.title}</span>
                     <span class="year">${it.year}</span>`;
      listEl.appendChild(div);
    });
  }

  function exportPNG(){
    const items=parseAll(source.value);
    if(!items.length){alert('Liste vide');return;}
    const pad=24,rowH=42,tagPadX=10,width=1000,height=pad*2+items.length*rowH;
    const canvas=document.createElement('canvas');
    canvas.width=width*DPR;canvas.height=height*DPR;
    const ctx=canvas.getContext('2d');ctx.setTransform(DPR,0,0,DPR,0,0);
    ctx.fillStyle='#0f1220';ctx.fillRect(0,0,width,height);
    ctx.fillStyle='#e6e8ef';ctx.font='600 18px ui-sans-serif';ctx.fillText('Otomelist',pad,pad+18);
    let y=pad+28;ctx.font='14px ui-sans-serif';
    items.forEach(it=>{
      const c=colorFor(it.type);
      const tw=ctx.measureText(it.type).width;
      const tagW=Math.ceil(tw)+tagPadX*2,tagH=24;
      roundedRect(ctx,pad,y-18,tagW,tagH,12,c.bg,c.border);
      ctx.fillStyle=c.text;ctx.fillText(it.type,pad+tagPadX,y-18+16);
      ctx.fillStyle='#e6e8ef';ctx.fillText(it.title,pad+tagW+12,y-18+16);
      const year=String(it.year);const yearW=ctx.measureText(year).width;
      ctx.fillStyle='#9aa3b2';ctx.fillText(year,width-pad-yearW,y-18+16);
      y+=rowH;
    });
    const url=canvas.toDataURL('image/png');
    exportImg.src=url;exportLink.href=url;exportArea.style.display='block';
    exportArea.scrollIntoView({behavior:'smooth'});
  }

  function roundedRect(ctx,x,y,w,h,r,fill,stroke){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
    if(fill){ctx.fillStyle=fill;ctx.fill();}
    if(stroke){ctx.strokeStyle=stroke;ctx.lineWidth=1;ctx.stroke();}
  }

  document.getElementById('btn-render').addEventListener('click',render);
  document.getElementById('btn-export').addEventListener('click',exportPNG);
})();
</script>
</body>
</html>
