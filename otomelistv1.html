<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OtomeList</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --muted:#9aa3b2; --text:#e6e8ef; --brand:#7c5cff; --badge:#2a2f4a;
      --ok:#19c37d; --warn:#ffb020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
         background:radial-gradient(1200px 800px at 10% -10%, #1b1f36 0%, rgba(27,31,54,0) 60%),
                    radial-gradient(1000px 700px at 110% 10%, #221b44 0%, rgba(34,27,68,0) 60%), var(--bg);
         color:var(--text)}
    header{position:sticky; top:0; z-index:5; backdrop-filter:saturate(140%) blur(8px);
           background:linear-gradient(180deg, rgba(15,18,32,0.9) 0%, rgba(15,18,32,0.6) 100%);
           border-bottom:1px solid #262b44}
    .wrap{max-width:1100px; margin:0 auto; padding:16px}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, var(--brand), #00e7ff)}
    .title{font-weight:700; letter-spacing:0.3px}
    .controls{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:12px}
    @media (min-width: 860px){ .controls{grid-template-columns: 1.2fr 1fr} }
    textarea{width:100%; min-height:150px; background:var(--panel); color:var(--text); border:1px solid #2a2f4a;
             border-radius:12px; padding:12px; resize:vertical; box-shadow: inset 0 0 0 1px #1f2340}
    .panel{background:var(--panel); border:1px solid #2a2f4a; border-radius:14px; padding:12px}
    .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .row > *{flex:1 1 auto}
    .btn{appearance:none; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600;
         background:linear-gradient(180deg, #2a2f4a, #222640); color:#e8eafb; box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn:hover{filter:brightness(1.08)}
    .btn.ghost{background:transparent; border:1px solid #2a2f4a; color:var(--muted)}
    .btn.warn{background:linear-gradient(180deg, #49320f, #3a2408); color:#ffd99b}
    .btn.ok{background:linear-gradient(180deg, #124a37, #0f3d2e); color:#b6ffe0}
    .inputs{display:grid; grid-template-columns: 1fr; gap:8px}
    @media (min-width: 640px){ .inputs{grid-template-columns: 1fr 1fr 1fr} }
    .input{display:flex; gap:8px; align-items:center}
    .input input, .input select{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #2a2f4a; background:#15182a; color:var(--text)}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:6px 10px; border-radius:999px; background:var(--badge); border:1px solid #32375a; font-size:12px; color:#c9d0e0}
    main{max-width:1100px; margin:18px auto; padding:0 16px}

    /* 2-column responsive layout for list */
    .list-grid{display:grid; grid-template-columns: 1fr; gap:16px}
    @media (min-width: 980px){ .list-grid{grid-template-columns: 1fr 1fr;} }

    .list{display:flex; flex-direction:column; gap:8px}
    .year-head{margin:10px 0 4px; padding:6px 10px; color:var(--muted); font-weight:700; letter-spacing:0.3px; border-left:3px solid #2a2f4a; border-radius:6px}
    .item{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px; background:var(--panel); border:1px solid #2a2f4a; border-radius:12px; padding:10px 12px}
    .item .tag{border:1px solid #32375a; border-radius:999px; padding:4px 8px; font-size:12px; color:#e6e8ef; background:#2a2f4a; transition:filter .15s ease}
    .item .tag:hover{filter:brightness(1.1)}
    .item .title{font-weight:600}
    .item .year{color:var(--muted)}

    .empty{opacity:.7; border:1px dashed #384067; padding:22px; border-radius:12px; text-align:center}
    footer{max-width:1100px; margin:32px auto 40px; padding:0 16px; color:var(--muted); text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <div class="brand"><div class="logo"></div><div class="title">OtomeList</div></div>
        <div class="chips" id="chips"></div>
      </div>
      <div class="controls">
        <div class="panel">
          <div class="row" style="margin-bottom:8px; justify-content:space-between">
            <strong>Paste your list</strong>
            <div class="row" style="gap:6px; flex:0 0 auto">
              <button class="btn ghost" id="btn-eg">Example</button>
              <button class="btn warn" id="btn-clear">Clear</button>
              <button class="btn ok" id="btn-save">Save</button>
              <button class="btn" id="btn-export">Export PNG</button>
              <button class="btn ghost" id="btn-tests">Tests</button>
            </div>
          </div>
          <p style="opacity:.8;font-size:14px;margin-top:6px">Example: <code>[tag] title (year)</code></p>
          <textarea id="source" placeholder="Accepted format:\n[type] Title (2024)\nor\nisekai Title 2025"></textarea>
          <div class="inputs" style="margin-top:10px">
            <div class="input"><label for="q" style="min-width:70px; color:var(--muted)">Search</label><input id="q" placeholder="Title…"/></div>
            <div class="input"><label for="typeSel" style="min-width:70px; color:var(--muted)">Type</label><select id="typeSel"><option value="">All</option></select></div>
            <div class="input"><label for="sortSel" style="min-width:70px; color:var(--muted)">Sort</label><select id="sortSel">
              <option value="yearDesc">Year ↓</option>
              <option value="yearAsc">Year ↑</option>
              <option value="titleAsc">Title A→Z</option>
              <option value="titleDesc">Title Z→A</option>
            </select></div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="list-grid">
        <section class="list" id="listCol1"></section>
        <section class="list" id="listCol2"></section>
      </div>
      <div id="empty" class="empty" style="display:none">No results. Adjust filters or search.</div>
    </div>
  </main>

  <div class="wrap" id="exportArea" style="display:none; margin-top:8px">
    <div class="panel">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
        <strong>Export preview</strong>
        <a id="exportLink" class="btn" download="anime-list.png">Download</a>
      </div>
      <img id="exportImg" alt="List PNG preview" style="max-width:100%; border:1px solid #2a2f4a; border-radius:10px"/>
      <div style="color:#9aa3b2; font-size:12px; margin-top:6px">If the download doesn’t start automatically, use the “Download” button above.</div>
    </div>
  </div>

  <footer>@ <span id="year"></span> OtomeList</footer>

<script>
// Single, self-contained script — no globals leakage
(function(){
  // ---------- Helpers ----------
  const $ = (sel) => document.querySelector(sel);
  const on = (el,ev,fn)=> el && el.addEventListener(ev,fn);
  const html=(el,s='')=>{ if(el) el.innerHTML=s; };
  const val=(el,fb='')=> (el && 'value' in el) ? el.value : fb;

  // ---------- Elements ----------
  const col1 = $('#listCol1');
  const col2 = $('#listCol2');
  const source = $('#source');
  const q = $('#q');
  const typeSel = $('#typeSel');
  const sortSel = $('#sortSel');
  const chips = $('#chips');
  const empty = $('#empty');
  const exportArea = $('#exportArea');
  const exportImg = $('#exportImg');
  const exportLink = $('#exportLink');
  const footerYear = $('#year');

  const DPR = Math.max(1, window.devicePixelRatio || 1);
  const STORAGE_KEY = 'animeListRaw_v1';

  // ---------- Sample ----------
  const SAMPLE = `isekai The Dark History of the Reincarnated Villainess 2025\nisekai The Most Heretical Last Boss Queen: From Villainess to Savior 2024\n[Otome] Isekai de l’héroïne réincarnée (2023)\n[Villainess] Isekai de l’héroïne réincarnée (2020)\n[Fantasy] Isekai de l’héroïne réincarnée (2023)`;

  // ---------- Utils ----------
  const clean = (s)=> (s||'').trim().replace(/\s{2,}/g,' ');
  const titleCase = (s)=> (s||'').replace(/(^|\s|-|_)([\p{L}\p{M}])/gu,(m,p1,p2)=>p1+p2.toUpperCase());
  const escapeHtml = (s)=> String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // ---------- Parsing ----------
  function parseLine(line){
    if(!line) return null; let m;
    // [type] Title (YYYY)
    m = line.match(/^\s*\[(.+?)\]\s*(.+?)\s*\((\d{4})\)\s*$/u);
    if(m) return { type:titleCase(clean(m[1])), title:clean(m[2]), year:+m[3] };
    // type Title YYYY
    m = line.match(/^\s*([\p{L}\p{M}\p{N}_-]+)\s+(.+?)\s+(\d{4})\s*$/u);
    if(m) return { type:titleCase(clean(m[1])), title:clean(m[2]), year:+m[3] };
    // Title (YYYY)
    m = line.match(/^\s*(.+?)\s*\((\d{4})\)\s*$/u);
    if(m) return { type:'Other', title:clean(m[1]), year:+m[2] };
    return null;
  }
  function parseAll(text){
    const items=[], errors=[];
    (text||'').split(/\n+/).forEach((raw,idx)=>{ const it=parseLine(raw.trim()); if(it) items.push({...it,_line:idx+1}); else if(raw.trim()) errors.push({line:idx+1, raw}); });
    return { items, errors };
  }

  // ---------- Colors ----------
  function colorFor(key){ let h=0; for(let i=0;i<key.length;i++) h=(h*31 + key.charCodeAt(i))>>>0; const hue=h%360; return { bg:`hsl(${hue} 55% 20% / 0.7)`, border:`hsl(${hue} 60% 38% / 0.9)`, text:`hsl(${hue} 80% 85% / 0.98)` }; }
  function hslToRgb(h,s,l){ h=((h%360)+360)%360; const c=(1-Math.abs(2*l-1))*s, hp=h/60, x=c*(1-Math.abs(hp%2-1)); let r=0,g=0,b=0; if(0<=hp&&hp<1){r=c;g=x;} else if(hp<2){r=x;g=c;} else if(hp<3){g=c;b=x;} else if(hp<4){g=x;b=c;} else if(hp<5){r=x;b=c;} else {r=c;b=x;} const m=l-c/2; return [Math.round((r+m)*255),Math.round((g+m)*255),Math.round((b+m)*255)]; }
  const rgba=(r,g,b,a)=>`rgba(${r},${g},${b},${a})`;
  function canvasColors(key){ let h=0; for(let i=0;i<key.length;i++) h=(h*31 + key.charCodeAt(i))>>>0; const hue=h%360; const a=hslToRgb(hue,0.55,0.20), b=hslToRgb(hue,0.60,0.38), t=hslToRgb(hue,0.80,0.85); return { bg:rgba(a[0],a[1],a[2],0.7), border:rgba(b[0],b[1],b[2],0.9), text:rgba(t[0],t[1],t[2],0.98) }; }

  // ---------- Render (2 columns, grouped by year) ----------
  function render(){
    const { items } = parseAll(val(source));
    let list = items;
    const qv = clean(val(q)).toLowerCase(); if(qv) list = list.filter(x=> x.title.toLowerCase().includes(qv));
    const tval = val(typeSel); if(tval) list = list.filter(x=> x.type === tval);

    const s = val(sortSel,'yearDesc');
    list = list.slice().sort((a,b)=>{
      if(s==='yearDesc') return (b.year - a.year) || a.title.localeCompare(b.title);
      if(s==='yearAsc')  return (a.year - b.year) || a.title.localeCompare(b.title);
      if(s==='titleAsc') return a.title.localeCompare(b.title) || (b.year - a.year);
      if(s==='titleDesc')return b.title.localeCompare(a.title) || (b.year - a.year);
      return 0;
    });

    html(col1,''); html(col2,'');
    if(!list.length){ if(empty) empty.style.display='block'; return; } else { if(empty) empty.style.display='none'; }

    // group by year
    const groups = new Map();
    list.forEach(it=>{ if(!groups.has(it.year)) groups.set(it.year, []); groups.get(it.year).push(it); });
    const years = Array.from(groups.keys()).sort((a,b)=> s==='yearAsc' ? a-b : b-a);

    // simple balancing by estimated height
    let h1=0, h2=0;
    years.forEach(yv=>{
      const arr = groups.get(yv);
      const container = document.createElement('div');
      const head = document.createElement('div'); head.className='year-head'; head.textContent = yv + ' —';
      container.appendChild(head);
      arr.forEach(it=>{
        const row = document.createElement('div'); row.className='item';
        const {bg,border,text} = colorFor(it.type);
        row.innerHTML = `<span class="tag" style="background:${bg}; border-color:${border}; color:${text}">${escapeHtml(it.type)}</span>
                         <span class="title">${escapeHtml(it.title)}</span>
                         <span class="year">${it.year}</span>`;
        container.appendChild(row);
      });
      const est = 1 + arr.length;
      if(h1<=h2){ col1.appendChild(container); h1+=est; } else { col2.appendChild(container); h2+=est; }
    });
  }

  // ---------- Filters ----------
  function populateFilters(){
    const { items } = parseAll(val(source));
    const types = [...new Set(items.map(x=>x.type))].sort((a,b)=> a.localeCompare(b));
    if(typeSel) typeSel.innerHTML = '<option value="">All</option>' + types.map(t=>`<option>${t}</option>`).join('');
    if(chips) chips.innerHTML = types.map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('');
  }

  // ---------- Export PNG (grouped by year) ----------
  function exportPNG(){
    let { items } = parseAll(val(source));
    const qv = clean(val(q)).toLowerCase();
    const tval = val(typeSel);
    const s = val(sortSel,'yearDesc');
    if(qv) items = items.filter(x=> x.title.toLowerCase().includes(qv));
    if(tval) items = items.filter(x=> x.type === tval);
    items.sort((a,b)=>{ if(s==='yearDesc') return (b.year-a.year)||a.title.localeCompare(b.title); if(s==='yearAsc') return (a.year-b.year)||a.title.localeCompare(b.title); if(s==='titleAsc') return a.title.localeCompare(b.title)||(b.year-a.year); if(s==='titleDesc') return b.title.localeCompare(a.title)||(b.year-a.year); return 0; });
    if(!items.length){ toast('Nothing to export (empty list / filters)'); return; }

    const groups = new Map(); items.forEach(it=>{ if(!groups.has(it.year)) groups.set(it.year, []); groups.get(it.year).push(it); });
    const years = Array.from(groups.keys()).sort((a,b)=> s==='yearAsc' ? a-b : b-a);

    const pad=24, rowH=42, headH=30, tagPadX=10, width=1000;
    const totalRows = years.reduce((acc,y)=> acc + 1 + groups.get(y).length, 0);
    const height = pad*2 + totalRows*rowH + years.length*(headH-rowH);

    const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d'); if(!ctx){ toast('Canvas not supported'); return; }
    canvas.width=width*DPR; canvas.height=height*DPR; canvas.style.width=width+'px'; canvas.style.height=height+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);

    // background + title
    ctx.fillStyle='#0f1220'; ctx.fillRect(0,0,width,height);
    ctx.fillStyle='#e6e8ef'; ctx.font='600 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'; ctx.fillText('OtomeList', pad, pad-6+18);

    let y=pad+28; ctx.font='14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
    years.forEach(yv=>{
      ctx.fillStyle='#9aa3b2'; ctx.font='700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'; ctx.fillText(String(yv)+' —', pad, y); y+=headH; ctx.font='14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      groups.get(yv).forEach(it=>{
        const c = canvasColors(it.type); const tagText=it.type; const tw=ctx.measureText(tagText).width; const tagW=Math.ceil(tw)+tagPadX*2; const tagH=24;
        // rounded badge
        ctx.beginPath(); const r=12, x=pad, yy=y-18, w=tagW, h=tagH; ctx.moveTo(x+r,yy); ctx.arcTo(x+w,yy,x+w,yy+h,r); ctx.arcTo(x+w,yy+h,x,yy+h,r); ctx.arcTo(x,yy+h,x,yy,r); ctx.arcTo(x,yy,x+w,yy,r); ctx.closePath(); ctx.fillStyle=c.bg; ctx.fill(); ctx.lineWidth=1; ctx.strokeStyle=c.border; ctx.stroke();
        ctx.fillStyle=c.text; ctx.fillText(tagText, pad+tagPadX, y-18+16);
        ctx.fillStyle='#e6e8ef'; ctx.fillText(it.title, pad+tagW+12, y-18+16);
        const year=String(it.year); const yearW=ctx.measureText(year).width; ctx.fillStyle='#9aa3b2'; ctx.fillText(year, width-pad-yearW, y-18+16);
        y+=rowH;
      });
    });

    const url = canvas.toDataURL('image/png');
    if(exportArea && exportImg && exportLink){ exportImg.src=url; exportLink.href=url; exportArea.style.display='block'; try{ exportArea.scrollIntoView({behavior:'smooth'}); }catch(_){} }
  }

  function roundedRect(ctx,x,y,w,h,r,fill,stroke){
    ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
    if(fill){ctx.fillStyle=fill;ctx.fill();} if(stroke){ctx.strokeStyle=stroke;ctx.lineWidth=1;ctx.stroke();}
  }

  function toast(msg){ const n=document.createElement('div'); n.textContent=msg; n.style.position='fixed'; n.style.bottom='16px'; n.style.left='50%'; n.style.transform='translateX(-50%)'; n.style.background='linear-gradient(180deg,#124a37,#0f3d2e)'; n.style.color='#b6ffe0'; n.style.padding='10px 14px'; n.style.borderRadius='10px'; n.style.border='1px solid #1f6e55'; n.style.boxShadow='0 10px 22px rgba(0,0,0,.35)'; n.style.zIndex='9999'; document.body.appendChild(n); setTimeout(()=>n.remove(),1600); }

  // ---------- Tests ----------
  function runTests(){
    const cases = [
      { name:'type title year', in:'isekai The Dark History of the Reincarnated Villainess 2025', want:{type:'Isekai', title:'The Dark History of the Reincarnated Villainess', year:2025} },
      { name:'[type] title (year)', in:'[isekai] The Most Heretical Last Boss Queen: From Villainess to Savior (2024)', want:{type:'Isekai', title:'The Most Heretical Last Boss Queen: From Villainess to Savior', year:2024} },
      { name:'title (year) → Other', in:'Isekai de l’héroïne réincarnée (2023)', want:{type:'Other', title:'Isekai de l’héroïne réincarnée', year:2023} },
      // extras
      { name:'unicode type', in:'фэнтези Title 2022', want:{type:'Фэнтези', title:'Title', year:2022} },
      { name:'dash in title', in:'isekai A-Title With Dashes 2021', want:{type:'Isekai', title:'A-Title With Dashes', year:2021} },
      { name:'extra spaces', in:'  isekai   Spaced    Title   2020  ', want:{type:'Isekai', title:'Spaced Title', year:2020} }
    ];
    let pass=0, fail=0; const lines=[];
    cases.forEach(tc=>{ const got=parseLine(tc.in); const ok=!!got && got.type===tc.want.type && got.title===tc.want.title && got.year===tc.want.year; ok?pass++:fail++; lines.push((ok?'[PASS] ':'[FAIL] ')+tc.name+'\n  in: '+tc.in+'\n  got: '+JSON.stringify(got)+'\n  want: '+JSON.stringify(tc.want)); });
    toast(`Tests: ${pass} pass, ${fail} fail`);
    console.log(lines.join('\n\n'));
  }

  // ---------- Persistence ----------
  function saveRaw(){ try{ localStorage.setItem(STORAGE_KEY, val(source)); }catch(_){} }
  function loadRaw(){ try{ return localStorage.getItem(STORAGE_KEY) || ''; }catch(_){ return ''; } }

  // ---------- Events ----------
  let deb; const debounce=(fn)=>{ clearTimeout(deb); deb=setTimeout(fn,120); };
  on(source,'input', ()=>debounce(()=>{ populateFilters(); render(); }));
  on(q,'input', ()=>render());
  on(typeSel,'change', ()=>render());
  on(sortSel,'change', ()=>render());
  on($('#btn-eg'),'click', ()=>{ if(source){ source.value=SAMPLE; populateFilters(); render(); } });
  on($('#btn-clear'),'click', ()=>{ if(source){ source.value=''; populateFilters(); render(); } });
  on($('#btn-save'),'click', ()=>{ saveRaw(); toast('Data saved locally.'); });
  on($('#btn-export'),'click', ()=>exportPNG());
  on($('#btn-tests'),'click', ()=>runTests());

  // ---------- Init ----------
  if(footerYear) footerYear.textContent = String(new Date().getFullYear());
  const raw = loadRaw(); if(source){ if(!val(source).trim()) source.value = raw || source.value || SAMPLE; }
  populateFilters();
  render();
})();
</script>
</body>
</html>
